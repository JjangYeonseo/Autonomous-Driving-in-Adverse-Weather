import subprocess
import os
import yaml
import re
import datetime
import pandas as pd

CONFIG_PATH = "configs/config.yaml"
CHECKPOINT_BASE_DIR = "checkpoints/"
LOG_DIR = "logs"
EXPERIMENT_LOG = os.path.join(LOG_DIR, "experiment_log.csv")

def run_command(cmd):
    print(f"\nâ–¶ ì‹¤í–‰: {cmd}")
    result = subprocess.run(cmd, shell=True)
    if result.returncode != 0:
        print(f"âŒ ì˜¤ë¥˜ ë°œìƒ: {cmd}")
        exit(1)

def get_latest_checkpoint():
    if not os.path.exists(CHECKPOINT_BASE_DIR):
        return None
    run_dirs = [d for d in os.listdir(CHECKPOINT_BASE_DIR) if d.startswith("run_")]
    if not run_dirs:
        return None
    latest_run = sorted(run_dirs)[-1]
    latest_dir = os.path.join(CHECKPOINT_BASE_DIR, latest_run)
    pt_files = [f for f in os.listdir(latest_dir) if f.endswith(".pt")]
    if not pt_files:
        return None
    pt_files.sort(key=lambda x: int(re.findall(r'\d+', x)[-1]))
    return os.path.join(latest_dir, pt_files[-1]), latest_dir

def update_config_model_path(config_path, model_path):
    with open(config_path, 'r', encoding='utf-8') as f:
        config = yaml.safe_load(f)
    config['test'] = {'model_path': model_path}
    with open(config_path, 'w', encoding='utf-8') as f:
        yaml.dump(config, f)
    print(f"âœ… config.yamlì— model_path ì—…ë°ì´íŠ¸ë¨: {model_path}")
    return config

def save_config_log(config, save_dir):
    os.makedirs(LOG_DIR, exist_ok=True)
    timestamp = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")

    # 1. config ë³µì‚¬ ì €ì¥
    config_copy_path = os.path.join(LOG_DIR, f"config_{timestamp}.yaml")
    with open(config_copy_path, 'w', encoding='utf-8') as f:
        yaml.dump(config, f)

    # 2. ìš”ì•½ í…ìŠ¤íŠ¸ ë¡œê·¸ ì €ì¥
    summary_path = os.path.join(LOG_DIR, f"summary_{timestamp}.txt")
    with open(summary_path, "w", encoding="utf-8") as f:
        f.write(f"ğŸ•’ ì‹¤í–‰ ì‹œê°„: {timestamp}\n")
        f.write(f"ğŸ“ ì €ì¥ ê²½ë¡œ: {save_dir}\n")
        f.write(f"ğŸ”¢ ìƒ˜í”Œ ìˆ˜: {config['dataset'].get('sample_size', 'ALL')}\n")
        f.write(f"ğŸ¯ í´ë˜ìŠ¤ ìˆ˜: {config['model']['num_classes']}\n")
        f.write(f"ğŸ“¦ ë°°ì¹˜ í¬ê¸°: {config['train']['batch_size']}\n")
        f.write(f"ğŸ“š ì—í­ ìˆ˜: {config['train']['epochs']}\n")
        f.write(f"ğŸš€ í•™ìŠµë¥ : {config['train']['lr']}\n")
        f.write(f"ğŸ§ª í…ŒìŠ¤íŠ¸ ëª¨ë¸: {config['test']['model_path']}\n")

    # 3. ì‹¤í—˜ ì´ë ¥ CSVì— ëˆ„ì 
    row = {
        'time': timestamp,
        'samples': config['dataset'].get('sample_size', 'ALL'),
        'classes': config['model']['num_classes'],
        'batch_size': config['train']['batch_size'],
        'epochs': config['train']['epochs'],
        'lr': config['train']['lr'],
        'ckpt_path': config['test']['model_path']
    }
    if not os.path.exists(EXPERIMENT_LOG):
        pd.DataFrame([row]).to_csv(EXPERIMENT_LOG, index=False)
    else:
        df = pd.read_csv(EXPERIMENT_LOG)
        df = pd.concat([df, pd.DataFrame([row])], ignore_index=True)
        df.to_csv(EXPERIMENT_LOG, index=False)

    print(f"ğŸ“š ë¡œê·¸ ì €ì¥ ì™„ë£Œ â†’ {summary_path}, {EXPERIMENT_LOG}")

def main():
    print("ğŸš€ Robust Detection Pipeline ì‹œì‘")

    # 1. í•™ìŠµ
    run_command(f"python scripts/train.py --config {CONFIG_PATH}")

    # 2. ì²´í¬í¬ì¸íŠ¸ ê²½ë¡œ íƒìƒ‰
    latest_ckpt, run_dir = get_latest_checkpoint()
    if not latest_ckpt:
        print("âŒ ì²´í¬í¬ì¸íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return

    # 3. config.yamlì— í…ŒìŠ¤íŠ¸ ëª¨ë¸ ê²½ë¡œ ì—…ë°ì´íŠ¸
    config = update_config_model_path(CONFIG_PATH, latest_ckpt)

    # 4. ë¡œê·¸ ì €ì¥
    save_config_log(config, run_dir)

    # 5. í…ŒìŠ¤íŠ¸
    run_command(f"python scripts/test.py --config {CONFIG_PATH}")

    # 6. í‰ê°€
    run_command("python scripts/evaluate.py")

    # 7. ì‹œê°í™”
    run_command(f"python -c \"import yaml; "
                f"from utils.visualization import visualize_predictions; "
                f"config=yaml.safe_load(open('{CONFIG_PATH}', encoding='utf-8')); "
                f"visualize_predictions(config, sample_count=10)\"")

    print("\nğŸ‰ ì „ì²´ íŒŒì´í”„ë¼ì¸ ì™„ë£Œ!")

if __name__ == "__main__":
    main()
